/// ----------------------------------------------------------------------
/// Prisma Schema – Omnixys Event Service (Microservice Version)
/// Author: Caleb Gyamfi – Omnixys Technologies
/// ----------------------------------------------------------------------

generator client {
  provider = "prisma-client"
  output   = "../src/prisma/generated"
}

datasource db {
  provider = "postgresql"
  schemas  = ["event"]
}

//
// ──────────────────────────────────────────────────────────
// EVENT ROOT
// ──────────────────────────────────────────────────────────
//
model Event {
  id       String   @id @default(cuid()) @map("id")
  name     String   @map("name")
  startsAt DateTime @map("starts_at")
  endsAt   DateTime @map("ends_at")

  allowReEntry  Boolean @default(true) @map("allow_re_entry")
  rotateSeconds Int     @default(300) @map("rotate_seconds")
  maxSeats      Int     @default(50) @map("max_seats")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (single)
  address   EventAddress?
  settings  EventSettings?
  theme     EventTheme?
  owner     EventOwner?
  analytics EventAnalytics?

  // Relations (lists)
  media       EventMedia[]
  description EventDescriptionBlock[]
  faqs        EventFAQ[]
  team        EventTeamMember[]
  auditLogs   EventAuditLog[]
  timeline    EventTimeline[]
  userRoles   UserEventRole[]

  @@map("event")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// ADDRESS
// ──────────────────────────────────────────────────────────
//
model EventAddress {
  id      String @id @default(cuid()) @map("id")
  eventId String @unique @map("event_id")

  street  String @map("street")
  city    String @map("city")
  zip     String @map("zip")
  country String @map("country")

  latitude  Float @map("latitude")
  longitude Float @map("longitude")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_address")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// SETTINGS (JSON)
// ──────────────────────────────────────────────────────────
//
model EventSettings {
  id      String @id @default(cuid()) @map("id")
  eventId String @unique @map("event_id")

  data Json @map("data")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_settings")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// THEME (JSON)
// ──────────────────────────────────────────────────────────
//
model EventTheme {
  id      String @id @default(cuid()) @map("id")
  eventId String @unique @map("event_id")

  colors     Json? @map("colors")
  layout     Json? @map("layout")
  typography Json? @map("typography")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_theme")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// OWNER (Creator)
// ──────────────────────────────────────────────────────────
//
model EventOwner {
  id        String   @id @default(cuid()) @map("id")
  eventId   String   @unique @map("event_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("event_owner")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// ANALYTICS SNAPSHOT
// ──────────────────────────────────────────────────────────
//
model EventAnalytics {
  id      String @id @default(cuid()) @map("id")
  eventId String @unique @map("event_id")

  totalInvites Int @default(0) @map("total_invites")
  accepted     Int @default(0) @map("accepted")
  declined     Int @default(0) @map("declined")
  checkedIn    Int @default(0) @map("checked_in")
  inside       Int @default(0) @map("inside")
  outside      Int @default(0) @map("outside")

  lastUpdate DateTime @default(now()) @map("last_update")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_analytics")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// MEDIA (Hero, Gallery, Cover, Ticket BG)
// ──────────────────────────────────────────────────────────
//
model EventMedia {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  kind  String  @map("kind") // hero, gallery, cover…
  url   String  @map("url")
  alt   String? @map("alt")
  order Int     @map("order")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_media")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// DESCRIPTION BLOCKS (Hero, Text, Gallery, FAQ, etc.)
// ──────────────────────────────────────────────────────────
//
model EventDescriptionBlock {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  type    String  @map("type")
  order   Int     @map("order")
  visible Boolean @default(true) @map("visible")
  props   Json    @map("props")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_description_block")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// FAQ
// ──────────────────────────────────────────────────────────
//
model EventFAQ {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  question String @map("question")
  answer   String @map("answer")
  order    Int    @map("order")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_faq")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// TEAM MEMBERS
// ──────────────────────────────────────────────────────────
//
model EventTeamMember {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  name     String  @map("name")
  role     String  @map("role")
  imageUrl String? @map("image_url")
  order    Int     @map("order")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_team_member")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// AUDIT LOGS
// ──────────────────────────────────────────────────────────
//
model EventAuditLog {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  actorId   String   @map("actor_id")
  action    String   @map("action")
  data      Json?    @map("data")
  createdAt DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_audit_log")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// TIMELINE
// ──────────────────────────────────────────────────────────
//
model EventTimeline {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  type      String   @map("type")
  timestamp DateTime @map("timestamp")
  label     String   @map("label")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_timeline")
  @@schema("event")
}

//
// ──────────────────────────────────────────────────────────
// USER EVENT ROLES (local projection)
// ──────────────────────────────────────────────────────────
//
model UserEventRole {
  id      String   @id @default(cuid()) @map("id")
  userId  String   @map("user_id")
  eventId String   @map("event_id")
  role    UserRole @map("role")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
  @@map("user_event_role")
  @@schema("event")
}

enum UserRole {
  ADMIN
  SECURITY
  GUEST

  @@schema("event")
}
