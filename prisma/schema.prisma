/// ----------------------------------------------------------------------
/// Prisma Schema – Omnixys Seat Service
/// Author: Caleb Gyamfi – Omnixys Technologies
///
/// THIS SERVICE OWNS:
/// - Sections
/// - Tables
/// - Seats
/// - Seat Assignments
/// - Seat Layout Metadata
///
/// THIS SERVICE DOES NOT OWN:
/// - Event information
///   → eventId is a foreign reference by ID only (no FK relationship)
/// ----------------------------------------------------------------------

generator client {
  provider = "prisma-client"
  output   = "../src/prisma/generated"
}

datasource db {
  provider = "postgresql"
  schemas  = ["seat"]
}

//
// ─────────────────────────────────────────────────────────────
// SECTION
// Represents logical areas such as VIP, Germany, Family, Main Floor
// ─────────────────────────────────────────────────────────────
//

model Section {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  name     String @map("name")
  order    Int    @map("order")
  capacity Int?   @map("capacity")
  meta     Json   @map("meta") // color, layout settings, shape, etc.

  x Float @default(0)
  y Float @default(0)

  tables Table[]
  seats  Seat[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([eventId, name])
  @@index([eventId])
  @@map("section")
  @@schema("seat")
}

//
// ─────────────────────────────────────────────────────────────
// TABLE
// Round table, row table, sector area, etc.
// ─────────────────────────────────────────────────────────────
//

model Table {
  id        String @id @default(cuid()) @map("id")
  eventId   String @map("event_id")
  sectionId String @map("section_id")

  name     String @map("name") // e.g. "1", "A", "Tisch 7"
  order    Int    @map("order")
  capacity Int?   @map("capacity")
  meta     Json   @map("meta")

  x Float @default(0)
  y Float @default(0)

  seats Seat[]

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([sectionId, name])
  @@index([eventId])
  @@map("table")
  @@schema("seat")
}

//
// ─────────────────────────────────────────────────────────────
// SEAT
// Stores position, seatType, label, assigned guest, geometry
// ─────────────────────────────────────────────────────────────
//

model Seat {
  id     String     @id @default(cuid()) @map("id")
  status SeatStatus @default(AVAILABLE)

  eventId   String  @map("event_id")
  sectionId String  @map("section_id")
  tableId   String? @map("table_id")

  number Int?    @map("number")
  label  String? @map("label")
  note   String? @map("note")

  x        Float? @map("x")
  y        Float? @map("y")
  rotation Float? @map("rotation")

  seatType String? @map("seat_type") // VIP, Standard, Staff, Standing, etc.

  guestId      String? @map("guest_id") // stored as ID only (from Invitation/User service)
  invitationId String? @map("invitation_id")
  meta         Json    @map("meta")

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([eventId, invitationId])
  @@unique([eventId, guestId])
  @@index([eventId])
  @@index([guestId])
  @@index([sectionId])
  @@index([tableId])
  @@map("seat")
  @@schema("seat")
}

//
// ─────────────────────────────────────────────────────────────
// SEAT ASSIGNMENT LOG (historical tracking)
// OPTIONAL but very useful for security & audit
// ─────────────────────────────────────────────────────────────
//

model SeatAssignmentLog {
  id           String  @id @default(cuid()) @map("id")
  eventId      String  @map("event_id")
  seatId       String  @map("seat_id")
  guestId      String? @map("guest_id")
  invitationId String? @map("invitation_id")

  action String @map("action") // "ASSIGNED", "UNASSIGNED", "MOVED"
  data   Json?  @map("data")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventId])
  @@index([seatId])
  @@map("seat_assignment_log")
  @@schema("seat")
}

//
// ─────────────────────────────────────────────────────────────
// LAYOUT VERSIONING (optional but recommended)
// Allows saving snapshots: v1, v2, v3 → Undo/Redo, drafts, publishing
// ─────────────────────────────────────────────────────────────
//

model LayoutVersion {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  version BigInt  @map("version")
  label   String? @map("label")
  data    Json    @map("data") // full seating JSON snapshot

  patch        Json? @map("patch")
  inversePatch Json? @map("inverse_patch")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([eventId, version])
  @@index([eventId])
  @@map("layout_version")
  @@schema("seat")
}

//
// ─────────────────────────────────────────────────────────────
// LAYOUT CHANGE LOG (incremental diff logs)
// Perfect for CRDT-like syncing in the future
// ─────────────────────────────────────────────────────────────
//

model LayoutChangeLog {
  id      String @id @default(cuid()) @map("id")
  eventId String @map("event_id")

  actorId String @map("actor_id")
  type    String @map("type") // "SEAT_MOVE", "SECTION_UPDATE", "TABLE_CREATE"...
  payload Json   @map("payload")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventId])
  @@map("layout_change_log")
  @@schema("seat")
}

enum SeatStatus {
  AVAILABLE
  RESERVED
  ASSIGNED
  BLOCKED

  @@schema("seat")
}
